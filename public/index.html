const axios = require('axios');

exports.handler = async function(event) {
  const code = event.queryStringParameters.code;
  const client_id = '161922';
  const client_secret = 'a8123e04f2a9599b4c2600b4cf567e833448aced';

  try {
    // Exchange code for Strava access token
    const tokenRes = await axios.post('https://www.strava.com/oauth/token', {
      client_id,
      client_secret,
      code,
      grant_type: 'authorization_code'
    });
    const access_token = tokenRes.data.access_token;
    const athlete_id = tokenRes.data.athlete.id;

    // Fetch last 5 activities for speed
    const activitiesRes = await axios.get(
      'https://www.strava.com/api/v3/athlete/activities?per_page=5',
      { headers: { Authorization: `Bearer ${access_token}` } }
    );

    // Calculate total watt-hours
    let totalWh = 0;
    activitiesRes.data.forEach(activity => {
      const avgWatts = activity.average_watts || 0;
      const durationSec = activity.elapsed_time || 0;
      totalWh += (avgWatts * durationSec) / 3600;
    });
    const totalWATT = (totalWh / 10).toFixed(2);
    const count = activitiesRes.data.length;

    // Redirect back with query params
    const redirectUrl =
      `https://melodious-queijadas-d749fe.netlify.app/` +
      `?athlete_id=${athlete_id}` +
      `&watt_token=${totalWATT}` +
      `&activities_count=${count}`;

    return {
      statusCode: 302,
      headers: { Location: redirectUrl },
      body: ''
    };

  } catch (err) {
    return {
      statusCode: 500,
      body: JSON.stringify({ error: err.message })
    };
  }
};

// ===========================
// ðŸ“„ public/index.html (Homepage)
// ===========================
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$WATT â€” Ride to Earn</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Ride. Earn. Repeat.</h1>
      <p>Welcome back! Here's your real-time dashboard.</p>
    </header>
    <section id="dashboard-stats">
      <div class="stat-card">
        <h3>$WATT Balance</h3>
        <p id="watt-display">Loading...</p>
      </div>
      <div class="stat-card">
        <h3>Rides Tracked</h3>
        <p id="rides-count">Loading...</p>
      </div>
    </section>
    <section id="leaderboard">
      <h2>Global Leaderboard</h2>
      <ol id="leader-list">
        <!-- Filled dynamically -->
      </ol>
    </section>
    <section id="profile-features">
      <h2>Your Account</h2>
      <ul>
        <li><a href="/login.html">Edit Profile</a></li>
        <li><a href="#ride-history">Ride History</a></li>
        <li><a href="#settings">Settings</a></li>
        <li><a href="#rewards">Rewards & Merch</a></li>
      </ul>
    </section>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    const config = { apiKey:'AIzaSyAuklQzaRb5kqqn3WiwqLQDOvFo6JdYgMA', authDomain:'wattcoinstorage.firebaseapp.com', projectId:'wattcoinstorage' };
    const app = initializeApp(config), db = getFirestore(app);
    const params = new URLSearchParams(window.location.search);
    const athleteId = params.get('athlete_id') || localStorage.getItem('athlete_id');
    const wattToken = params.get('watt_token');
    const count = params.get('activities_count');
    if (athleteId && wattToken && count) {
      setDoc(doc(db, 'users', athleteId), { athlete_id: athleteId, watt_token: wattToken, activities_count: count, updated_at: new Date().toISOString() });
      localStorage.setItem('athlete_id', athleteId);
    }
    if (athleteId) {
      getDoc(doc(db, 'users', athleteId)).then(snap => {
        if (snap.exists()) {
          document.getElementById('watt-display').innerText = snap.data().watt_token + ' $WATT';
          document.getElementById('rides-count').innerText = snap.data().activities_count;
        }
      });
    }
    // TODO: fetch and display leaderboard
  </script>
</body>
</html>

// ===========================
// ðŸ“„ public/login.html (User Account Login)
// ===========================
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login â€” $WATT</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Welcome to $WATT</h1>
      <p>Please log in to access your dashboard and track your $WATT earnings.</p>
    </header>
    <section id="login-form">
      <form>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="you@example.com" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="********" required>
        </div>
        <button type="submit" class="button">Log In</button>
      </form>
      <p>Or continue with:</p>
      <a class="button" href="https://www.strava.com/oauth/authorize?client_id=161922&response_type=code&redirect_uri=https://melodious-queijadas-d749fe.netlify.app/.netlify/functions/strava-auth&approval_prompt=auto&scope=activity:read_all">
        ðŸš´ Connect with Strava
      </a>
    </section>
    <section id="extras">
      <h2>Coming Soon</h2>
      <ul>
        <li>Ride History & Analytics</li>
        <li>Profile & Avatar Customization</li>
        <li>Achievements & Badges</li>
        <li>Referral Program</li>
      </ul>
    </section>
  </div>
</body>
</html>
