<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$WATT â€” Ride to Earn</title>
  <style>
    /* Styles omitted for brevity */
  </style>
</head>
<body>
  <!-- Hero & How It Works omitted -->

  <section id="connect">
    <h2>Connect with Strava</h2>
    <a class="button" href="https://www.strava.com/oauth/authorize?client_id=161922&response_type=code&redirect_uri=https://melodious-queijadas-d749fe.netlify.app/.netlify/functions/strava-auth&approval_prompt=auto&scope=activity:read_all">
      ðŸš´ Connect Strava Now
    </a>
  </section>

  <section id="your-balance">
    <h2>Your $WATT</h2>
    <div id="watt-display">Loading...</div>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // Firebase config
    const config = {apiKey:'AIza...P0W',authDomain:'wattcoinstorage.firebaseapp.com',projectId:'wattcoinstorage'};
    const app = initializeApp(config);
    const db = getFirestore(app);

    // Read query params
    const params = new URLSearchParams(window.location.search);
    const athleteId = params.get('athlete_id');
    const wattToken = params.get('watt_token');
    const activitiesCount = params.get('activities_count');

    if (athleteId && wattToken && activitiesCount) {
      // Persist in Firestore
      setDoc(doc(db, 'users', athleteId), {
        athlete_id: athleteId,
        watt_token: wattToken,
        activities_count: activitiesCount,
        updated_at: new Date().toISOString()
      });
      localStorage.setItem('athlete_id', athleteId);
    }

    // Display from Firestore
    const storedId = athleteId || localStorage.getItem('athlete_id');
    if (storedId) {
      getDoc(doc(db,'users', storedId)).then(snap => {
        document.getElementById('watt-display').innerText = snap.exists()
          ? `You've earned ${snap.data().watt_token} $WATT from ${snap.data().activities_count} rides.`
          : 'No data found.';
      });
    }
  </script>
</body>
</html>
